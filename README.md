# PyXCAT
This repo contains a wrapper for the XCAT program written in python for ease of use.

You will need [XCAT](https://www.hopkinsmedicine.org/radiology/research/divisions/radiological-physics/research/projects/imaging-simulation-computer-phantoms.html) to generate synthetic CT volumes. 

# Overview
+ [generate_volume.py](https://github.com/HReynaud/PyXCAT/blob/main/generate_volume.py): contains the code to generate a volume using XCAT. The volume(s) are transformed to the .nii.gz format after generation to save space and make them easy to use with medical imaging libraries like SimpleITK and Nibabel.
+ [generate_multiple_volumes.py](https://github.com/HReynaud/PyXCAT/blob/main/generate_multiple_volumes.py): wraps the [generate_volume.py](https://github.com/HReynaud/PyXCAT/blob/main/generate_volume.py) file to generate multiple volumes in a multi-processing fashion for time optimized generation.
+ [sample_2d_plane.py](https://github.com/HReynaud/PyXCAT/blob/main/sample_2d_plane.py): lets you generate a 2D plane from a given volume from a triplet of x,y,z points.

# Usage
## Volume generation
Go to the directory where you downloaded this repo, and type: </br>
` python generate_volume.py -s 256 -t CT, SEG -n DEMO -o ./ -p PROGRAM_PATH -f 1 ` </br>
where `PROGRAM_PATH` is replaced with the path to your XCAT program folder. This will generate a CT volume and its corresponding segmentation volume, with names `DEMO_0_CT.nii.gz` and `DEMO_0_SEG.nii.gz`. Volumes will have dimensions 256x256x256 and will be centered on the torso.

### Arguments:
| Argument | Descrition |
| ------------------------------ | --- |
| `-s`,`--size`&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  | Integer to specify the size of the volume. The volume is always a cube centered on the torso, the size will change the resolution of the anatomy.|
| `-t`, `--types`| Types of volumes to generate, can be CT, SEG (segmentation), NURBS and ATN (Atenuation). Pass as a list, ex. `CT, SEG` |
| `-n`, `--name`| Base name for the generated files. Files will be named as `NAME_F_TYPE.nii.gz` where NAME is the base name, `F` is the frame index and `TYPE` is the type of the volume.|
| `-o`, `--output`| Path where the files will be saved.|
| `-p`, `--program`| Path to the XCAT program files. The specified folder should contain all program files, especillay the `dxcat2_linux_64bit` file and your `xcat2.cfg` file.|
| `-f`, `--frames`| The heart cycle is defined to last one second (60bpm) and frames will be sampled regularly over that time period. Use 1 by default.|
| `-v`, `--verbose`| Activate the verbose mode for more details during processing.|
| `--keep_raw`| By default, the raw binary files generated by XCAT are deleted, by specifying --keep_raw, those files are kept.|
| `--preview`| Generates a .jpg image of the slice sampled from the middle of the Z axis to give a preview of the volume content.|
| `--randomize`| Randomize the anatomical parameters within a sensible range to create some diversity accross volumes.|

## Parallel Volume Generation
This script will generate multiple volumes with randomized anatomical parameters (see the `--randomize` parameter). To launch it, go to the directory where you downloaded this repo and type: </br>
` python generate_multiple_volumes.py -c 10 -s 256 -t CT, SEG -n DEMO -o ./ -p PROGRAM_PATH -f 1 ` </br>
where `PROGRAM_PATH` is replaced with the path to your XCAT program folder. This will generate CT volumes and their corresponding segmentation volumes, with names `DEMOXX_0_CT.nii.gz` and `DEMOXX_0_SEG.nii.gz`, where XX will be a number between 0 and the specified number of volumes.

### Arguments:
| Argument | Descrition |
| ------------------------------ | --- |
| `-c`, `--count`| Number of volumes to generate. |
| `-s`,`--size`&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  | Integer to specify the size of the volume. The volume is always a cube centered on the torso, the size will change the resolution of the anatomy.|
| `-t`, `--types`| Types of volumes to generate, can be CT, SEG (segmentation), NURBS and ATN (Atenuation). Pass as a list, ex. `CT, SEG` |
| `-n`, `--name`| Base name for the generated files. Files will be named as `NAME_F_TYPE.nii.gz` where NAME is the base name, `F` is the frame index and `TYPE` is the type of the volume.|
| `-o`, `--output`| Path where the files will be saved.|
| `-p`, `--program`| Path to the XCAT program files. The specified folder should contain all program files, especillay the `dxcat2_linux_64bit` file and your `xcat2.cfg` file.|
| `-f`, `--frames`| The heart cycle is defined to last one second (60bpm) and frames will be sampled regularly over that time period. Use 1 by default.|
| `-v`, `--verbose`| Activate the verbose mode for more details during processing.|
| `--keep_raw`| By default, the raw binary files generated by XCAT are deleted, by specifying --keep_raw, those files are kept.|
| `--preview`| Generates a .jpg image of the slice sampled from the middle of the Z axis to give a preview of the volume content.|

## Plane sampling
The `sample_2d_plane.py` file lets you sample planes defined by 3 points in the volume. With this, it becomes easy to slice the volume at any angle. All resulting images will have a shape X and Y equal to a pair of dimensions from the volume. If the volume is a 256<sup>3</sup> cube, the image will be 256x256.
To run this script, you need a 3D .nii.gz file, like the ones generated by the afformentioned scripts, but any 3D .nii.gz will work. To launch it, go to the directory where you downloaded this repo and type: </br>
` python sample_2d_plane.py -f DEMO_0_CT.nii.gz -o image.jpg -A 0 0 0 -B 0 1 0 -C 1 0 1` </br>

### Arguments:
| Argument | Descrition |
| ------------------------------ | --- |
| `-f`, `--file` &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3D `.nii.gz` file from which the volume will be sampled |
| `-o`, `--output`| Path and name of the ouput file, ex. plane.jpg |
| `-A`| Point A, ex. `-A 0 0 0` |
| `-B`| Point B, ex. `-B 0 1 0` |
| `-C`| Point C, ex. `-C 1 0 1` |

The current way of sampling the planes is not optimal when sampling neighbouring planes. Any suggestion is welcome.


